generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- LOOKUP TABLES ---

model UserRole {
  id          String   @id @default(cuid())
  code        String   @unique // 'ADMIN', 'KASIR', 'MANAGER'
  name        String   // 'Administrator', 'Kasir', 'Manager'
  description String?
  isActive    Boolean  @default(true)
  users       User[]
  permissions RoleMenuPermission[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model CustomerType {
  id          String    @id @default(cuid())
  code        String    @unique // 'UMUM', 'TETAP', 'GROSIR'
  name        String    // 'Pelanggan Umum', 'Pelanggan Tetap', 'Grosir'
  canBon      Boolean   @default(false) // UMUM tidak bisa BON
  description String?
  isActive    Boolean   @default(true)
  customers   Customer[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model TransactionType {
  id            String        @id @default(cuid())
  code          String        @unique // 'LUNAS', 'BON'
  name          String        // 'Lunas', 'Bon'
  description   String?
  isActive      Boolean       @default(true)
  transactions  Transaction[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

// --- MODEL USER (Login & Akses) ---

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String   // Hash password
  name      String
  role      UserRole @relation(fields: [roleId], references: [id])
  roleId    String
  isActive  Boolean  @default(true)
  returPenjualanApproved ReturPenjualan[] // Retur yang disetujui oleh user ini
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([roleId])
}

// --- MODEL PENGGUNA ---

model Customer {
  id        String       @id @default(cuid())
  name      String
  type      CustomerType @relation(fields: [typeId], references: [id])
  typeId    String
  address   String?
  phone     String?
  email     String?
  debt      Decimal      @default(0)
  transactions Transaction[]
  returPenjualan ReturPenjualan[]
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@index([typeId])
}

// --- MODEL GUDANG ---

model Warehouse {
  id          String        @id @default(cuid())
  name        String        @unique
  address     String?
  isDefault   Boolean       @default(false) // Gudang utama
  isActive    Boolean       @default(true)
  stockItems  StockItem[]
  stockHistory StockHistory[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

// --- MODEL STOK PER GUDANG ---

model StockItem {
  id          String    @id @default(cuid())
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  warehouseId String
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId   String
  stock       Int       @default(0) // Stok dalam satuan terkecil
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([warehouseId, productId])
  @@index([warehouseId])
  @@index([productId])
}

// --- MODEL PRODUK & STOK ---

model Distributor {
  id              String                @id @default(cuid())
  name            String                 @unique
  address         String?
  phone           String?
  email           String?
  contactPerson   String?
  debt            Decimal                @default(0) // Hutang ke supplier
  products        ProductDistributor[]  // Many-to-Many dengan Product
  purchaseOrders  PurchaseOrder[]
  returPembelian  ReturPembelian[]
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
}

model Product {
  id              String                @id @default(cuid())
  sku             String                @unique
  name            String
  brand           String?
  category        String?
  notes           String?
  stock           Int                   @default(0) // Stok total (calculated/sync)
  minStock        Int                   @default(10)
  
  // HAPUS: One-to-Many dengan Distributor
  // distributor     Distributor           @relation(fields: [distributorId], references: [id])
  // distributorId   String

  // TAMBAH: Many-to-Many dengan Distributor
  distributors    ProductDistributor[]  // Many-to-Many

  units           Unit[]                // Relasi: Satu produk punya banyak satuan
  stockItems      StockItem[]           // Relasi: Stok per gudang
  poItems         PurchaseOrderItem[]   // Relasi: Produk ini ada di banyak PO item
  stockHistory    StockHistory[]        // Relasi: Riwayat perubahan stok
  transactionItems TransactionItem[]    // Relasi: Produk ini ada di banyak transaksi
  returPenjualanItems ReturPenjualanItem[]
  returPembelianItems ReturPembelianItem[]

  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
}

// TAMBAH: Junction table untuk Many-to-Many Product â†” Distributor
model ProductDistributor {
  id            String      @id @default(cuid())
  productId     String
  distributorId String
  product       Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  distributor   Distributor @relation(fields: [distributorId], references: [id], onDelete: Cascade)
  stock         Int         @default(0) // Stok per supplier
  isDefault     Boolean     @default(false) // Supplier utama
  barcodes      Barcode[]   // Barcode per supplier
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@unique([productId, distributorId])
  @@index([productId])
  @@index([distributorId])
}

// TAMBAH: Model Barcode terikat dengan ProductDistributor
model Barcode {
  id                  String              @id @default(cuid())
  barcode             String              @unique // Nilai barcode (unik di seluruh sistem)
  productDistributor  ProductDistributor  @relation(fields: [productDistributorId], references: [id], onDelete: Cascade)
  productDistributorId String
  unit                Unit                @relation(fields: [unitId], references: [id], onDelete: Cascade)
  unitId              String
  createdAt           DateTime            @default(now())
  
  @@index([barcode]) // Index untuk pencarian cepat
}

model Unit {
  id            String    @id @default(cuid())
  name          String    // e.g., "Pcs", "Dus"
  price         Decimal   // Harga jual satuan ini
  conversion    Int       // e.g., 1 untuk Pcs, 40 untuk Dus
  hasBarcode    Boolean   @default(false) // Penanda apakah satuan ini punya barcode
  // HAPUS: barcodes      String[]  // Array barcode
  // TAMBAH: Relasi ke Barcode
  barcodes      Barcode[] // Relasi ke Barcode

  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId     String

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([productId, name]) // Produk tidak bisa punya 2 satuan "Pcs"
}

// --- MODEL PURCHASE ORDER (PO) ---

model PurchaseOrder {
  id            String    @id @default(cuid())
  status        String    @default("PENDING") // 'PENDING', 'COMPLETED'
  
  distributor   Distributor @relation(fields: [distributorId], references: [id])
  distributorId String
  
  items         PurchaseOrderItem[] // Relasi: Satu PO punya banyak item

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([status])
}

model PurchaseOrderItem {
  id            String    @id @default(cuid())
  qty           Int
  unitName      String    // e.g., "Dus". Kita simpan sbg string (denormalisasi)
  
  po            PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)
  poId          String
  
  product       Product   @relation(fields: [productId], references: [id])
  productId     String
}

// --- MODEL RIWAYAT STOK ---

model StockHistory {
  id            String          @id @default(cuid())
  product       Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId     String
  warehouse     Warehouse?      @relation(fields: [warehouseId], references: [id], onDelete: SetNull)
  warehouseId   String?
  
  type          String          // Jenis perubahan stok: 'IN', 'OUT', 'ADJUSTMENT', 'RETURN_SALE', 'RETURN_PURCHASE', 'TRANSFER_IN', 'TRANSFER_OUT'
  qtyChange     Int             // Perubahan jumlah (bisa positif atau negatif)
  qtyBefore     Int             // Stok sebelum perubahan
  qtyAfter      Int             // Stok setelah perubahan
  unitName      String?         // Nama satuan yang digunakan (opsional)
  note          String?         // Catatan/keterangan (opsional)
  
  // Reference untuk tracking (opsional)
  referenceId   String?         // ID referensi (misal: PO ID, Transaction ID)
  referenceType String?         // Tipe referensi (misal: "PO", "TRANSACTION", "OPNAME", "TRANSFER")
  
  createdAt     DateTime        @default(now())

  @@index([productId, createdAt])
  @@index([warehouseId])
  @@index([type])
}

// --- MODEL TRANSAKSI PENJUALAN ---

model Transaction {
  id            String            @id @default(cuid())
  invoiceNumber String            @unique // Nomor invoice/nota
  type          TransactionType   @relation(fields: [typeId], references: [id])
  typeId        String
  customer      Customer          @relation(fields: [customerId], references: [id])
  customerId    String
  subtotal      Decimal           // Total sebelum diskon
  discount      Decimal           @default(0) // Diskon total
  total         Decimal           // Total setelah diskon
  paid          Decimal           @default(0) // Uang yang dibayar
  change        Decimal           @default(0) // Kembalian
  note          String?
  items         TransactionItem[]
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([customerId, createdAt])
  @@index([invoiceNumber])
  @@index([typeId])
}

model TransactionItem {
  id            String      @id @default(cuid())
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId String
  product       Product     @relation(fields: [productId], references: [id])
  productId     String
  productName   String      // Denormalisasi untuk riwayat
  unitName      String      // Satuan yang digunakan
  qty           Int
  price         Decimal     // Harga per unit saat transaksi
  discount      Decimal     @default(0) // Diskon per item
  subtotal      Decimal     // (price * qty) - discount
}

// --- MODEL RETUR PENJUALAN ---

model ReturPenjualan {
  id            String              @id @default(cuid())
  invoiceNumber String              // Nomor invoice yang diretur
  customer      Customer            @relation(fields: [customerId], references: [id])
  customerId    String
  total         Decimal             // Total retur
  refundAmount  Decimal             // Uang yang dikembalikan
  status        String              @default("PENDING") // 'PENDING', 'APPROVED', 'REJECTED'
  approvedBy    User?               @relation(fields: [approvedById], references: [id])
  approvedById   String?
  approvedAt     DateTime?
  rejectedReason String?            // Alasan penolakan jika ditolak
  note          String?
  items         ReturPenjualanItem[]
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@index([customerId, createdAt])
  @@index([status])
}

model ReturPenjualanItem {
  id              String        @id @default(cuid())
  returPenjualan  ReturPenjualan @relation(fields: [returPenjualanId], references: [id], onDelete: Cascade)
  returPenjualanId String
  product         Product       @relation(fields: [productId], references: [id])
  productId       String
  productName     String
  unitName        String
  qty             Int
  priceAtRetur    Decimal       // Harga saat retur
  subtotal        Decimal
}

// --- MODEL RETUR PEMBELIAN ---

model ReturPembelian {
  id            String              @id @default(cuid())
  poNumber      String              // Nomor PO yang diretur
  distributor   Distributor         @relation(fields: [distributorId], references: [id])
  distributorId String
  total         Decimal
  note          String?
  items         ReturPembelianItem[]
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@index([distributorId, createdAt])
}

model ReturPembelianItem {
  id              String        @id @default(cuid())
  returPembelian  ReturPembelian @relation(fields: [returPembelianId], references: [id], onDelete: Cascade)
  returPembelianId String
  product         Product       @relation(fields: [productId], references: [id])
  productId       String
  productName     String
  unitName        String
  qty             Int
  priceAtRetur    Decimal
  subtotal        Decimal
}

// --- MODEL EMAIL QUOTA TRACKING ---

model EmailQuota {
  id        String   @id @default(cuid())
  date      DateTime @unique @default(now()) // Tanggal (hanya tanggal, tanpa waktu)
  count     Int      @default(0) // Jumlah email yang sudah dikirim hari ini
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
}

// --- MODEL STORE (Informasi Toko) ---

model Store {
  id          String   @id @default(cuid())
  name        String   // Nama toko
  address     String?  // Alamat toko
  phone       String?  // Telepon toko
  email       String?  // Email toko
  website     String?  // Website toko
  npwp        String?  // NPWP
  owner       String?  // Nama pemilik
  description String?  // Deskripsi toko
  logo        String?  // URL logo toko
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([id]) // Hanya satu record store
}

// --- MODEL MENU ---
model Menu {
  id          String   @id @default(cuid())
  code        String   @unique // 'MASTER_BARANG', 'PENJUALAN', dll
  name        String   // 'Master Barang', 'Penjualan'
  path        String   // '/master-barang', '/'
  icon        String?  // Nama icon dari heroicons
  category    String?  // 'MASTER_DATA', 'TRANSAKSI', 'STOK', dll
  order       Int      @default(0) // Urutan menu
  isActive    Boolean  @default(true)
  permissions RoleMenuPermission[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --- MODEL PERMISSION ROLE-MENU ---
model RoleMenuPermission {
  id          String   @id @default(cuid())
  role        UserRole @relation(fields: [roleId], references: [id], onDelete: Cascade)
  roleId      String
  menu        Menu     @relation(fields: [menuId], references: [id], onDelete: Cascade)
  menuId      String
  canAccess   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([roleId, menuId])
  @@index([roleId])
  @@index([menuId])
}